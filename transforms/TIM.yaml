# Transform for TIM registers based on TIMA0 on G518x
#
# This generates a generic timer type which is independent of the counter register size.
# Other details such as the following are the responsibility of the HAL:
# - The number of capture and compare channels
# - Whether QDIR is present
# - Bit width of the timer (most timers are 16-bit, but 32-bit timers exist). 32-bit types are defined here.
transforms:
  - !DeleteUselessEnums

  # However DeleteUselessEnums does not delete MIS and IMASK (due to CLR being 0 and SET being 1)
  #
  # TODO: Add this to chiptool
  - !DeleteEnumsWithVariants
    variants:
      0: CLR
      1: SET

  # FREE is useless
  - !DeleteEnumsWithVariants
    variants:
      0: STOP
      1: RUN

  # RESETASSERT is useless
  - !DeleteEnumsWithVariants
    variants:
      0: NOP
      1: ASSERT

  # RESETSTKY is useless
  - !DeleteEnumsWithVariants
    variants:
      0: NORES
      1: RESET

  # RESETSTKYCLR is useless
  - !DeleteEnumsWithVariants
    variants:
      0: NOP
      1: CLR

  - !DeleteFieldsets
    from: .*
    useless: true

  # TODO: Something better than a cursed rename as merge
  - !MergeBlocks
    from: TIMA0
    main: TIMA0
    to: TIM

  # Remove prefixes
  - !RenameRegisters
    block: .*
    from: TIMA0_(.+)
    to: $1

  - !RenameFields
    fieldset: .*
    from: TIMA0_(.+)
    to: $1

  - !Rename
    type: All
    from: TIMA0_(.+)
    to: $1

  ## Interrupts and events
  - !MergeFieldsets
    from: CPU_INT_(IMASK|ISET|MIS|RIS|ICLR)
    to: CPU_INT
    check: NoCheck

  - !MergeFieldsets
    from: GEN_EVENT(\d+)_(IMASK|ISET|MIS|RIS|ICLR)
    to: GEN_EVENT_INT

  - !MergeEnums
    from: GEN_EVENT(\d+)_IIDX_STAT
    to: GEN_EVENT_IIDX_STAT
    main: GEN_EVENT0_IIDX_STAT

  - !MergeFieldsets
    from: GEN_EVENT(\d+)_IIDX
    to: GEN_EVENT_IIDX

  - !RenameRegisters
    block: CPU_INT
    from: CPU_INT_(.+)
    to: $1

  - !RenameRegisters
    block: GEN_EVENT(\d+)
    from: GEN_EVENT(\d+)_(.+)
    to: $2

  - !MergeBlocks
    from: GEN_EVENT(\d+)
    to: GEN_EVENT
    main: GEN_EVENT0

  - !MakeRegisterArray
    blocks: TIM
    from: GEN_EVENT(\d+)
    to: GEN_EVENT

  # TODO: Dearrayify CPU_INT

  # TIMA0 does not have the QEIERR or DC interrupt fields, manually add these.
  #
  # The QEI is of course only available on general-purpose timers, but we can
  # add these here since interrupts are common to all timer instances. And the HAL
  # is responsible for using the register correctly.
  - !AddFields
    fieldset: CPU_INT
    fields:
    - name: DC
      description: Direction change event
      bit_offset: 27
      bit_size: 1
    - name: QEIERR
      description: QEIERR event
      bit_offset: 28
      bit_size: 1

  - !AddFields
    fieldset: GEN_EVENT_INT
    fields:
    - name: DC
      description: Direction change event
      bit_offset: 27
      bit_size: 1
    - name: QEIERR
      description: QEIERR event
      bit_offset: 28
      bit_size: 1

  ## Publisher/Subscriber ports

  # CHANID is an int
  - !DeleteEnums
    from: .*_CHANID
    bit_size: 4

  - !MergeFieldsets
    from: (FPUB|FSUB)_\d+
    to: FPORT

  - !MakeRegisterArray
    blocks: .*
    from: (FSUB|FPUB)_[0-1]
    to: $1

  ## EVT_MODE
  - !MergeEnums
    from: EVT(\d+)_CFG
    to: EVT_CFG

  - !RenameFields
    fieldset: EVT_MODE
    from: EVT0_CFG
    to: CPU_INT_CFG

  - !MakeFieldArray
    fieldsets: EVT_MODE
    from: EVT(\d+)_CFG
    to: EVT_CFG

  # Add missing keys
  - !AddFields
    fieldset: RSTCTL
    fields:
    - name: KEY
      description: Unlock key B1h = KEY to allow write access to this register
      bit_offset: 24
      bit_size: 8
      enum: RESET_KEY
      access: Write

  - !AddFields
    fieldset: PWREN
    fields:
    - name: KEY
      description: KEY to allow Power State Change 26h = KEY to allow write access to this register
      bit_offset: 24
      bit_size: 8
      enum: PWREN_KEY
      access: Write
  
  - !Add
    ir:
      enum/RESET_KEY:
        bit_size: 8
        variants:
          - name: KEY
            value: 177
      enum/PWREN_KEY:
        bit_size: 8
        variants:
          - name: KEY
            value: 38

  # TODO: Dearrayify COUNTERREGS/COMMONREGS

  ## COUNTERREGS

  # CTR and LOAD are useless fieldsets. Just a u32 read/write.
  - !DeleteFieldsets
    from: (CTR|LOAD)

  - !MergeEnums
    from: CCCTL_(\d+)_COC
    to: COC
    main: CCCTL_01_COC

  - !MergeEnums
    from: CCCTL_(\d+)_CCOND
    to: CCOND
    main: CCCTL_01_CCOND

  - !MergeEnums
    from: CCCTL_(\d+)_ACOND
    to: ACOND
    main: CCCTL_01_ACOND

  - !MergeEnums
    from: CCCTL_(\d+)_LCOND
    to: LCOND
    main: CCCTL_01_LCOND

  - !MergeEnums
    from: CCCTL_(\d+)_ZCOND
    to: ZCOND
    main: CCCTL_01_ZCOND

  - !MergeEnums
    from: CCCTL_(\d+)_CCUPD
    to: CCUPD
    main: CCCTL_01_CCUPD

  - !MergeEnums
    from: CCCTL_(\d+)_CC2SELU
    to: CC2SELU
    main: CCCTL_01_CC2SELU

  - !MergeEnums
    from: CCCTL_(\d+)_CCACTUPD
    to: CCACTUPD
    main: CCCTL_01_CCACTUPD

  - !MergeEnums
    from: CCCTL_(\d+)_CC2SELD
    to: CC2SELD
    main: CCCTL_01_CC2SELD

  - !MergeFieldsets
    from: CCCTL_(01|23|45)
    to: CCCTL
    main: CCCTL_01
    # CCCTL4 and 5 only contain CUPD and SCERCNEZ. HAL is responsible for correct usage.
    check: NoCheck

  # CLC, CAC, CZC are same
  - !RenameEnumVariants
    enum: (CLC|CAC|CZC)
    from: CCCTL(\d+)_(\w+)
    to: CCTL$1

  - !MergeEnums
    from: (CLC|CAC|CZC)
    to: CxC

  # OCTL
  - !MergeEnums
    from: OCTL_(\d+)_CCPO
    to: CCPO
    main: OCTL_01_CCPO

  - !MergeEnums
    from: OCTL_(\d+)_CCPIV
    to: CCPIV
    main: OCTL_01_CCPIV

  - !MergeFieldsets
    from: OCTL_(01|23)
    to: OCTL
    main: OCTL_01

  # CCACT
  - !MergeEnums
    from: CCACT_(\d+)_(CC2DACT|DACT|CC2UACT|CDACT|CUACT|LACT|ZACT)
    to: ACT
    main: CCACT_01_ZACT

  - !MergeEnums
    from: CCACT_(\d+)_(FENACT|FEXACT)
    to: FACT
    main: CCACT_01_FENACT

  - !MergeEnums
    # match both normal and complementary
    from: CCACT_(\d+)_SWFRCACT(.*)
    to: SWFRCACT
    main: CCACT_01_SWFRCACT

  - !MergeFieldsets
    from: CCACT_(01|23)
    to: CCACT
    main: CCACT_01

  # IFCTL
  - !MergeEnums
    from: IFCTL_(\d+)_ISEL
    to: ISEL
    main: IFCTL_01_ISEL

  - !MergeEnums
    from: IFCTL_(\d+)_FP
    to: FP
    main: IFCTL_01_FP

  - !MergeEnums
    from: IFCTL_(\d+)_CPV
    to: CPV
    main: IFCTL_01_CPV

  - !MergeFieldsets
    from: IFCTL_(01|23)
    to: IFCTL
    main: IFCTL_01

  ## CC regs must be recreated because they are split in groups of 2
  - !DeleteRegisters
    block: COUNTERREGS
    from: (CC|CCCTL|OCTL|CCACT|IFCTL)_(01|23|45)

  - !DeleteFieldsets
    from: CC_(01|23|45)

  - !AddRegisters
    block: COUNTERREGS
    registers:
    - name: CC
      description: Compare or capture value 
      array:
        len: 6
        stride: 4
      byte_offset: 16
    - name: CCCTL
      description: Capture or compare control register
      array:
        len: 6
        stride: 4
      fieldset: CCCTL
      byte_offset: 48
    - name: OCTL
      description: CCP output control register
      array:
        len: 4
        stride: 4
      byte_offset: 80
      fieldset: OCTL
    - name: CCACT
      description: CCP output control register
      array:
        len: 4
        stride: 4
      byte_offset: 112
      fieldset: CCACT
    - name: IFCTL
      description: Input filter control register
      array:
        len: 4
        stride: 4
      byte_offset: 128
      fieldset: IFCTL

  ## ODIS, CCPD
  - !DeleteEnums
    from: (ODIS|CCPD)_C0CCP(\d+)

  - !MakeFieldArray
    fieldsets: (ODIS|CCPD)
    from: C0CCP(\d+)
    to: C0CCP

  # Ratio is useless
  - !DeleteEnums
    from: RATIO

  ## FCTL
  - !DeleteEnums
    from: (FSENAC|FSENEXT)(\d+)

  ## CTTRIG
  # enum/TRIG is useless
  - !DeleteEnums
    from: TRIG

  # FILTEN is useless
  - !DeleteEnums
    from: FILTEN

  # Add QDIR manually since it only exists in TIMG[8..11] and we generate from TIMA0
  - !Add
    ir:
      fieldset/QDIR:
        fields:
        - name: DIR
          bit_size: 1
          bit_offset: 0

  - !AddRegisters
    block: TIM
    registers:
    - name: QDIR
      byte_offset: 0x18BC
      fieldset: QDIR

  ## Cleanup
  - !Sort
